<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trincomalee Disaster Response Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use the 'Inter' font and a custom theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#059669', // Emerald Green
                        'secondary': '#1d4ed8', // Blue
                        'accent': '#f59e0b', // Amber
                        'vulnerable-infants': '#38bdf8', // Sky Blue
                        'vulnerable-under5': '#0ea5e9', // Light Blue
                        'vulnerable-pregnant': '#ec4899', // Pink
                        'background-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for visualization and aesthetics */
        .data-bar, .stack-segment {
            transition: width 0.8s ease-out;
            height: 100%;
        }
        .table-container {
            max-height: 80vh; /* Limit height for responsiveness */
            overflow-y: auto;
        }
        /* Custom icon SVG for the main header */
        .icon-svg {
            width: 96px;
            height: 96px;
            color: white;
        }
        
        /* Mobile optimization for horizontal stacked bar labels */
        @media (max-width: 640px) {
            .moh-label {
                width: 100%;
                text-align: left;
                margin-bottom: 0.25rem; /* space-y-1 */
            }
            .viz-item {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body class="bg-background-light font-sans p-4 sm:p-6 lg:p-10">

    <!-- Main Content Container -->
    <div id="app" class="max-w-7xl mx-auto space-y-12">

        <!-- Header Card: Logo, Title, and Date -->
        <header class="text-center">
            <div class="bg-primary shadow-2xl rounded-xl p-6 sm:p-10 text-white transform hover:scale-[1.01] transition duration-300">
                
                <!-- Logo Placeholder -->
                <div class="flex justify-center mb-4">
                    <svg class="icon-svg fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        <path d="M12 17V8"></path>
                        <path d="M16 11l-4 4-4-4"></path>
                    </svg>
                </div>
                
                <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-2">
                    Trincomalee District Disaster Response Dashboard
                </h1>
                <p class="text-xl sm:text-2xl font-semibold opacity-90">
                    Real-time status of welfare camps
                </p>

                <div class="mt-4 pt-4 border-t border-white border-opacity-30">
                    <p class="text-sm sm:text-lg font-medium">
                        Health Information Management Unit | Office of Regional Director of Health Services (RDHS)
                    </p>
                    <p class="text-lg font-light">
                        Trincomalee
                    </p>
                </div>

                <!-- Date Display -->
                <div class="mt-6">
                    <span id="data-date" class="inline-flex items-center text-sm font-bold bg-white text-primary rounded-full px-4 py-2 shadow-lg">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Data Last Updated: December 3rd, 2025
                    </span>
                </div>
            </div>
        </header>

        <!-- Brief Overview & Key Metrics -->
        <section class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-primary pb-2 flex items-center">
                <span class="mr-2">üìä</span> Situation Overview
            </h2>
            <p class="text-gray-600 text-lg">
                This dashboard provides a concise summary of the welfare camp status across the Trincomalee District, based on data received from various Medical Officer of Health (MOH) areas on December 3rd, 2025.
            </p>

            <!-- KPI Cards -->
            <div id="kpi-cards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                <!-- Cards will be injected by JavaScript -->
            </div>
        </section>

        <!-- Visualization Section 1: Affected Population (People) - NOW PIE CHART -->
        <section class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-primary pb-2 flex items-center">
                <span class="mr-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Affected Population (People) Distribution
            </h2>
            <div id="moh-people-visualization" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <!-- Pie Chart visualization will be injected by JavaScript -->
            </div>
        </section>
        
        <!-- Visualization Section 2: Families - NOW PIE CHART -->
        <section class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-accent pb-2 flex items-center">
                <span class="mr-2">üèòÔ∏è</span> Families Displaced Distribution
            </h2>
            <div id="moh-families-visualization" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <!-- Pie Chart visualization will be injected by JavaScript -->
            </div>
        </section>

        <!-- Visualization Section 3: Vulnerable Groups (Stacked Bar - Kept Horizontal for Composition Clarity) -->
        <section class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-secondary pb-2 flex items-center">
                <span class="mr-2">üö®</span> Vulnerable Population Breakdown
            </h2>
            <!-- Legend for Stacked Chart -->
            <div class="flex flex-wrap gap-4 text-sm font-semibold p-4 bg-white rounded-xl shadow-inner">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-2 bg-vulnerable-infants"></span> Infants</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-2 bg-vulnerable-under5"></span> Under 5</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-2 bg-vulnerable-pregnant"></span> Pregnant</div>
            </div>
            
            <div id="moh-vulnerable-visualization" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-6">
                <!-- Stacked Bar chart visualization (Horizontal) will be injected by JavaScript -->
            </div>
        </section>

        <!-- Detailed Data Table -->
        <section class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-gray-400 pb-2 flex items-center">
                <span class="mr-2">üìã</span> Detailed Welfare Camp Data
            </h2>
            
            <div class="table-container bg-white rounded-xl shadow-2xl">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="sticky top-0 bg-primary text-white shadow-md">
                        <tr>
                            <th class="px-3 py-3 text-left text-sm font-semibold uppercase tracking-wider rounded-tl-xl">MOH Area</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider">Families</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider">People</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider hidden sm:table-cell">Male</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider hidden sm:table-cell">Female</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider bg-vulnerable-infants/80">Infants</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider bg-vulnerable-under5/80">Under 5</th>
                            <th class="px-3 py-3 text-right text-sm font-semibold uppercase tracking-wider bg-vulnerable-pregnant/80 rounded-tr-xl">Pregnant</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Table rows will be injected by JavaScript -->
                    </tbody>
                    <tfoot id="data-table-footer">
                        <!-- Footer row will be injected by JavaScript -->
                    </tfoot>
                </table>
            </div>
        </section>

    </div>

    <!-- JavaScript for Data Handling and Rendering -->
    <script>
        const disasterData = [
            { moh: "Kuchaveli", families: 2, people: 10, male: 5, female: 5, infants: 0, under5: 2, pregnant: 0, deaths: 0, missing: 0 },
            { moh: "Gomarankadawela", families: 10, people: 0, male: 0, female: 0, infants: 0, under5: 0, pregnant: 0, deaths: 0, missing: 0 },
            { moh: "Padavisripura", families: 58, people: 122, male: 0, female: 0, infants: 0, under5: 0, pregnant: 0, deaths: 0, missing: 0 },
            { moh: "Uppuveli", families: 5, people: 26, male: 10, female: 14, infants: 0, under5: 0, pregnant: 0, deaths: 0, missing: 0 },
            { moh: "Trincomalee", families: 5, people: 5, male: 0, female: 0, infants: 0, under5: 0, pregnant: 0, deaths: 0, missing: 0 },
            { moh: "Kanthale", families: 139, people: 448, male: 218, female: 230, infants: 2, under5: 30, pregnant: 2, deaths: 0, missing: 0 },
            { moh: "Kurunjakerni", families: 299, people: 1048, male: 277, female: 278, infants: 6, under5: 35, pregnant: 5, deaths: 0, missing: 0 },
            { moh: "Seruwila", families: 536, people: 1564, male: 739, female: 825, infants: 10, under5: 88, pregnant: 4, deaths: 0, missing: 0 },
            { moh: "Echilampathu", families: 620, people: 1795, male: 518, female: 555, infants: 0, under5: 25, pregnant: 27, deaths: 0, missing: 0 },
            { moh: "Kinniya", families: 398, people: 1168, male: 544, female: 624, infants: 23, under5: 114, pregnant: 11, deaths: 0, missing: 0 },
            { moh: "Muthur", families: 3046, people: 9348, male: 4299, female: 4563, infants: 12, under5: 743, pregnant: 52, deaths: 0, missing: 0 },
            { moh: "Thambalagamam", families: 0, people: 0, male: 0, female: 0, infants: 0, under5: 0, pregnant: 0, deaths: 0, missing: 0 }
        ];

        // Custom color palette for pie charts
        const PIE_COLORS = [
            '#ef4444', // Red (Muthur - largest)
            '#3b82f6', // Blue
            '#10b981', // Emerald
            '#f97316', // Orange
            '#6366f1', // Indigo
            '#4b5563' // Gray-600 (for 'Other MOH Areas')
        ];
        const TOP_N_SLICES = 5;

        // 1. Calculate Totals
        const totals = disasterData.reduce((acc, curr) => {
            acc.families += curr.families;
            acc.people += curr.people;
            acc.male += curr.male;
            acc.female += curr.female;
            acc.infants += curr.infants;
            acc.under5 += curr.under5;
            acc.pregnant += curr.pregnant;
            acc.deaths += curr.deaths;
            acc.missing += curr.missing;
            return acc;
        }, { families: 0, people: 0, male: 0, female: 0, infants: 0, under5: 0, pregnant: 0, deaths: 0, missing: 0 });


        // === VISUALIZATION FUNCTIONS ===

        // Helper function for rendering a Pie Chart using SVG
        const renderPieChart = (containerId, dataKey, chartTitle) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // 1. Prepare and Aggregate Data
            const data = disasterData.map(d => ({
                moh: d.moh,
                value: d[dataKey]
            })).filter(d => d.value > 0)
              .sort((a, b) => b.value - a.value); // Sort descending

            if (data.length === 0) {
                container.innerHTML = `<p class="text-center w-full text-gray-500">No data available for ${chartTitle}.</p>`;
                return;
            }

            const totalValue = data.reduce((sum, d) => sum + d.value, 0);
            
            // Grouping: Take top N and combine the rest into 'Other'
            let slices = data.slice(0, TOP_N_SLICES);
            const otherSlices = data.slice(TOP_N_SLICES);

            if (otherSlices.length > 0) {
                const otherValue = otherSlices.reduce((sum, d) => sum + d.value, 0);
                slices.push({ moh: "Other MOH Areas", value: otherValue });
            }
            
            // 2. Generate Pie Slices (SVG)
            const svgSize = 300;
            const radius = svgSize / 2 - 10; // Minus 10 for padding
            const center = svgSize / 2;
            let startAngle = 0;
            
            // SVG and Labels Container Setup
            const chartArea = document.createElement('div');
            // Use flex-col on mobile and flex-row on desktop for responsive layout
            chartArea.className = "flex flex-col md:flex-row items-center justify-center p-2 space-y-4 md:space-y-0 md:space-x-12";
            
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", svgSize);
            svg.setAttribute("height", svgSize);
            svg.setAttribute("viewBox", `0 0 ${svgSize} ${svgSize}`);
            svg.className = "flex-shrink-0 shadow-xl rounded-full border border-gray-200";

            const labelContainer = document.createElement('div');
            labelContainer.className = "flex flex-col space-y-2 text-sm max-w-full md:max-w-sm w-full md:w-auto";
            
            slices.forEach((slice, index) => {
                const percentage = (slice.value / totalValue);
                const angle = percentage * 360;
                const endAngle = startAngle + angle;
                
                // Skip if slice is too small to draw (less than 0.5 degree)
                if (angle < 0.5) {
                    startAngle = endAngle;
                    return;
                }

                // Function to convert polar to cartesian coordinates
                const getCoords = (angle) => {
                    const radians = (angle - 90) * (Math.PI / 180);
                    return [
                        center + (radius * Math.cos(radians)),
                        center + (radius * Math.sin(radians))
                    ];
                };
                
                const [x1, y1] = getCoords(startAngle);
                const [x2, y2] = getCoords(endAngle);

                const largeArcFlag = angle > 180 ? 1 : 0;
                const color = PIE_COLORS[index % PIE_COLORS.length];
                
                // Define the SVG path (slice)
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M ${center},${center} L ${x1},${y1} A ${radius},${radius} 0 ${largeArcFlag},1 ${x2},${y2} Z`);
                path.setAttribute("fill", color);
                path.setAttribute("stroke", "white");
                path.setAttribute("stroke-width", "1");
                path.setAttribute("title", `${slice.moh}: ${slice.value.toLocaleString()} (${(percentage * 100).toFixed(1)}%)`);
                path.style.transition = 'transform 0.3s';
                
                // Add hover effect to slightly pull the slice out
                path.addEventListener('mouseenter', () => path.style.transform = 'scale(1.03)');
                path.addEventListener('mouseleave', () => path.style.transform = 'scale(1)');
                
                svg.appendChild(path);
                
                // 3. Generate Labels
                const percentageText = `${(percentage * 100).toFixed(1)}%`;
                const labelText = `${slice.moh}: ${slice.value.toLocaleString()} (${percentageText})`;
                const labelHtml = `
                    <div class="flex items-center p-2 rounded-lg transition duration-150 hover:bg-gray-100/50" title="${slice.moh}">
                        <span class="w-4 h-4 rounded-full mr-3 flex-shrink-0 shadow-sm" style="background-color: ${color};"></span>
                        <span class="text-gray-800 font-medium">${labelText}</span>
                    </div>
                `;
                labelContainer.innerHTML += labelHtml;

                startAngle = endAngle;
            });

            chartArea.appendChild(svg);
            chartArea.appendChild(labelContainer);
            container.appendChild(chartArea);

            // Add a note about the grouping
            if (otherSlices.length > 0) {
                const note = document.createElement('p');
                note.className = "text-center text-xs text-gray-500 mt-4 px-4";
                note.innerHTML = `Note: Smaller areas (constituting ${otherSlices.length} MOHs) are combined into 'Other MOH Areas' for a clearer visual distribution.`;
                container.appendChild(note);
            }
        };


        // Function for rendering the Stacked Bar Chart for Vulnerable Groups (kept horizontal for composition clarity)
        const renderVulnerableGroupsVisualization = () => {
            const container = document.getElementById('moh-vulnerable-visualization');
            container.innerHTML = '';

            const vulnerableData = disasterData.map(d => ({
                moh: d.moh,
                infants: d.infants,
                under5: d.under5,
                pregnant: d.pregnant,
                total: d.infants + d.under5 + d.pregnant
            })).filter(d => d.total > 0)
               .sort((a, b) => b.total - a.total); // Sort descending

            if (vulnerableData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No vulnerable population reported in any area.</p>`;
                return;
            }

            const maxVulnerable = Math.max(...vulnerableData.map(d => d.total));

            vulnerableData.forEach(item => {
                const totalPercentage = (item.total / maxVulnerable) * 100;
                
                const barHtml = `
                    <div class="viz-item flex flex-col sm:flex-row items-start sm:items-center space-y-1 sm:space-y-0 sm:space-x-4">
                        <div class="moh-label w-full sm:w-40 text-sm font-semibold text-gray-700 truncate">${item.moh}</div>
                        <div class="flex-grow w-full sm:w-auto bg-gray-200 rounded-full h-6 relative flex overflow-hidden shadow-inner" title="Total Vulnerable: ${item.total.toLocaleString()}">
                            <div class="stack-segment ${item.infants > 0 ? 'bg-vulnerable-infants' : 'hidden'}" 
                                 style="width: ${item.total > 0 ? (item.infants / item.total) * totalPercentage : 0}%;" 
                                 title="Infants: ${item.infants}">
                            </div>
                            <div class="stack-segment ${item.under5 > 0 ? 'bg-vulnerable-under5' : 'hidden'}" 
                                 style="width: ${item.total > 0 ? (item.under5 / item.total) * totalPercentage : 0}%;"
                                 title="Under 5: ${item.under5}">
                            </div>
                            <div class="stack-segment ${item.pregnant > 0 ? 'bg-vulnerable-pregnant' : 'hidden'}" 
                                 style="width: ${item.total > 0 ? (item.pregnant / item.total) * totalPercentage : 0}%;"
                                 title="Pregnant: ${item.pregnant}">
                            </div>
                            <span class="absolute right-2 top-0.5 text-xs font-bold text-gray-800 pointer-events-none">
                                ${item.total.toLocaleString()}
                            </span>
                        </div>
                    </div>
                `;
                container.innerHTML += barHtml;
            });
        };

        // === RENDER ALL ELEMENTS ON LOAD ===
        
        // 2. Render KPI Cards
        const kpiMetrics = [
            { label: "Total Affected People", value: totals.people, icon: "üë§", color: "bg-secondary", text: "text-white" },
            { label: "Total Families", value: totals.families, icon: "üè†", color: "bg-accent", text: "text-gray-800" },
            { label: "Vulnerable: Infants", value: totals.infants, icon: "üë∂", color: "bg-vulnerable-infants", text: "text-white" },
            { label: "Vulnerable: Under 5", value: totals.under5, icon: "üßí", color: "bg-vulnerable-under5", text: "text-white" },
            { label: "Vulnerable: Pregnant", value: totals.pregnant, icon: "ü§∞", color: "bg-vulnerable-pregnant", text: "text-white" },
        ];
        
        const kpiContainer = document.getElementById('kpi-cards');
        kpiMetrics.forEach(metric => {
            const card = `
                <div class="${metric.color} ${metric.text} p-4 rounded-xl shadow-lg border border-gray-100 transform hover:shadow-xl transition duration-200">
                    <div class="text-4xl mb-2">${metric.icon}</div>
                    <p class="text-xs font-semibold uppercase opacity-80">${metric.label}</p>
                    <p class="text-3xl font-extrabold mt-1">${metric.value.toLocaleString()}</p>
                </div>
            `;
            kpiContainer.innerHTML += card;
        });

        // 3. Render all MOH Visualizations (Now Pie Charts)
        renderPieChart('moh-people-visualization', 'people', 'Affected Population (People)');
        renderPieChart('moh-families-visualization', 'families', 'Families Displaced');
        renderVulnerableGroupsVisualization();


        // 4. Render Detailed Data Table
        const tableBody = document.getElementById('data-table-body');
        tableBody.innerHTML = ''; // Clear existing content
        disasterData.forEach((item, index) => {
            const rowClass = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
            const rowHtml = `
                <tr class="${rowClass} transition duration-150 ease-in-out">
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.moh}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-semibold text-accent">${item.families.toLocaleString()}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-extrabold text-secondary">${item.people.toLocaleString()}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right hidden sm:table-cell">${item.male.toLocaleString()}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right hidden sm:table-cell">${item.female.toLocaleString()}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-medium bg-vulnerable-infants/10 text-vulnerable-infants">${item.infants.toLocaleString()}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-medium bg-vulnerable-under5/10 text-vulnerable-under5">${item.under5.toLocaleString()}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-medium bg-vulnerable-pregnant/10 text-vulnerable-pregnant">${item.pregnant.toLocaleString()}</td>
                </tr>
            `;
            tableBody.innerHTML += rowHtml;
        });

        // Render Table Footer (Totals)
        const tableFooter = document.getElementById('data-table-footer');
        tableFooter.innerHTML = ''; // Clear existing content
        const footerHtml = `
            <tr class="bg-gray-800 text-white font-bold text-base sticky bottom-0">
                <td class="px-3 py-3 whitespace-nowrap rounded-bl-xl">TOTALS</td>
                <td class="px-3 py-3 text-right">${totals.families.toLocaleString()}</td>
                <td class="px-3 py-3 text-right">${totals.people.toLocaleString()}</td>
                <td class="px-3 py-3 text-right hidden sm:table-cell">${totals.male.toLocaleString()}</td>
                <td class="px-3 py-3 text-right hidden sm:table-cell">${totals.female.toLocaleString()}</td>
                <td class="px-3 py-3 text-right bg-vulnerable-infants/90">${totals.infants.toLocaleString()}</td>
                <td class="px-3 py-3 text-right bg-vulnerable-under5/90">${totals.under5.toLocaleString()}</td>
                <td class="px-3 py-3 text-right bg-vulnerable-pregnant/90 rounded-br-xl">${totals.pregnant.toLocaleString()}</td>
            </tr>
        `;
        tableFooter.innerHTML += footerHtml;

    </script>
</body>
</html>
